<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radar + NWS Alerts + FIRMS Fire Data</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #controls, #alerts {
      position: absolute; z-index: 1000; background: white;
      padding: 10px; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: sans-serif; font-size: 13px;
    }
    #controls { top: 10px; left: 10px; }
    #alerts {
      bottom: 10px; left: 10px;
      max-height: 250px; width: 300px; overflow-y: auto;
    }
    button { margin-top: 5px; }
    a.alert-link { color: #0077cc; text-decoration: underline; font-size: 12px; }
  </style>
</head>
<body>

<div id="controls">
  <strong>Radar Animation</strong><br>
  <button id="toggleBtn">Pause</button>
</div>

<div id="alerts">
  <strong>Live Weather Alerts (Active Only)</strong>
  <div id="alertFeed">Loading...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
  const map = L.map('map').setView([37.8, -96], 5);

  // Base map
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
  }).addTo(map);

  // FIRMS fire hotspots WMS layer
  const FIRMS_KEY = '98816b6dadda86b7a77d0477889142db';
  const firmsLayer = L.tileLayer.wms(
    'https://firms.modaps.eosdis.nasa.gov/wms/c6', {
      map_key: FIRMS_KEY,
      layers: 'fires_modis_24,fires_viirs_noaa20_24',
      format: 'image/png',
      transparent: true,
      version: '1.1.1',
      attribution: '&copy; NASA FIRMS'
    }
  );

  // Add layer control (fires off by default)
  const overlayMaps = {
    'Radar': L.layerGroup(),
    'NWS Alerts': L.layerGroup(),
    'FIRMS Fires': firmsLayer
  };
  L.control.layers(null, overlayMaps).addTo(map);

  // Radar animation logic...
  let radarFrames = [], radarLayers = [], frameIndex = 0, radarInterval, radarPlaying = true;
  function startRadar() {
    radarInterval = setInterval(() => {
      radarLayers.forEach((lyr,i) => lyr.setOpacity(i === frameIndex ? 0.6 : 0));
      frameIndex = (frameIndex + 1) % radarLayers.length;
    }, 333);
  }
  function stopRadar() { clearInterval(radarInterval); }

  document.getElementById("toggleBtn")
    .addEventListener("click", () => {
      radarPlaying = !radarPlaying;
      document.getElementById("toggleBtn").innerText = radarPlaying ? "Pause" : "Play";
      radarPlaying ? startRadar() : stopRadar();
    });

  fetch("https://api.rainviewer.com/public/weather-maps.json")
    .then(r => r.json())
    .then(d => {
      radarFrames = d.radar?.past || [];
      let loaded = 0;
      radarFrames.forEach(f => {
        const url = `https://tilecache.rainviewer.com/v2/radar/${f.path}/256/{z}/{x}/{y}/2/1_1.png`;
        const lyr = L.tileLayer(url, { opacity: 0, zIndex: 10 });
        lyr.on('load', () => {
          if (++loaded === radarFrames.length) {
            radarLayers[0].setOpacity(0.6);
            overlayMaps['Radar'].addTo(map);
            if (radarPlaying) startRadar();
          }
        });
        radarLayers.push(lyr);
        overlayMaps['Radar'].addLayer(lyr);
      });
    });

  // NWS alerts with county polygons
  let countyGeo = null;
  const alertLayer = overlayMaps['NWS Alerts'];
  function getColor(evt) {
    const e = evt.toLowerCase();
    if (e.includes("extreme heat")) return "red";
    if (e === "severe thunderstorm warning") return "orange";
    if (e === "flash flood warning") return "blue";
    if (e === "flood advisory") return "lightblue";
    if (e === "flood warning") return "#3399cc";
    if (e === "flood watch") return "green";
    if (e === "heat advisory") return "#ffcc66";
    if (e === "red flag warning") return "pink";
    return "#999";
  }

  function fetchAlerts() {
    if (!countyGeo) return;
    fetch("https://api.weather.gov/alerts/active").then(r=>r.json())
    .then(d=>{
      const now = Date.now();
      const alerts = d.features.filter(f=>{
        const p = f.properties;
        return new Date(p.expires).getTime() > now &&
               p.event.toLowerCase() !== "special weather statement";
      });
      document.getElementById("alertFeed").innerHTML =
        alerts.length === 0 ? "<p>No active alerts.</p>" :
        alerts.map(f => {
          const p = f.properties;
          return `<div style="margin-bottom:10px">
            <strong>${p.event}</strong><br/>
            <em>${p.areaDesc}</em><br/>
            <span style="color:gray;">${p.severity} - ${p.urgency}</span><br/>
            ${p.headline}<br/>
            <small>Expires: ${new Date(p.expires).toLocaleString()}</small><br/>
            <a class="alert-link" href="${p['@id']}" target="_blank">View Alert</a>
          </div>`;
        }).join("");
      alertLayer.clearLayers();
      alerts.forEach(alert=>{
        const p = alert.properties;
        const codes = p.geocode?.SAME || [];
        const fips = codes.map(c => c.length===6 ? c.slice(1) : c);
        const features = countyGeo.features.filter(feat => fips.includes(feat.id));
        if (features.length) {
          L.geoJSON({type:"FeatureCollection", features}, {
            style: () => ({
              color: getColor(p.event),
              weight: 2, opacity: 0.8, fillOpacity: 0.1
            }),
            onEachFeature: (feat, lyr) => {
              lyr.bindPopup(`
                <strong>${p.event}</strong><br/>
                ${p.headline}<br/>
                <small>Expires: ${new Date(p.expires).toLocaleString()}</small><br/>
                <a class="alert-link" href="${p['@id']}" target="_blank">View Alert</a>
              `);
            }
          }).addTo(alertLayer);
        }
      });
    });
  }

  fetch("https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json")
    .then(r => r.json())
    .then(g => {
      countyGeo = g;
      fetchAlerts();
      setInterval(fetchAlerts, 5*60*1000);
    });
</script>
</body>
</html>
